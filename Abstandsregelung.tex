\chapter{Abstandsregelung}\label{chp:Abstandsregelung}
In diesem Kapitel geht es um die Bearbeitung von Aufgabe 3, sprich der
Abstandsregelung des Systems. Dazu haben wir uns im wesentlichen an der
Schematischen Darstellung in Abbildung~\ref{fig:abstand_as} gehalten.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.69\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/abstand_aufgabenstelllung.png}
\end{subfigure}
    \caption{Schematischer Aufbau der Regelung in der Aufgabenstellung
    \label{fig:abstand_as}}
\end{figure}    
In Teil~\ref{sec:Übersicht Gesamtsystem} wird zunächst eine Übersicht über die
gesamte Abstandsregelung gegeben, wobei dann in den darauffolgenden Kapiteln
genauer auf die jeweiligen Einzelteile eingegangen wird.

%-------------------------------------------------------------------------------
\section{Übersicht Gesamtsystem}\label{sec:Übersicht Gesamtsystem}
ToDo: Gesamtsystem müsste auch mal fertig sein
\begin{figure}[hbt]
\centering
\begin{subfigure}{1.0\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/gesamtsystem.png}
\end{subfigure}
    \caption{Übersicht über das Gesamtsystem
    \label{fig:gesamt}}
\end{figure}    

%-------------------------------------------------------------------------------
\section{Zustandsgenerator}\label{sec:zustandsgenerator}
Ziel des Zustandsgenerators ist es die jeweiligen Positionen der Fahrzeuge aus
den gegebenen Sensoren (Position des rechten/linken Rads, Ultraschallsensor) zu
generieren. Eine Übersicht ist in Abbildung~\ref{fig:zustandsgenerator}
dargestellt.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.79\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/zustandsgenerator.png}
\end{subfigure}
    \caption{Übersicht über die Implementierung des Zustandsgenerators
    \label{fig:zustandsgenerator}}
\end{figure}    
Zunächst wird der kommulierte Winkel zwischen den beiden Rädern gemittelt. Dies
ist notwendig, da das rechte und das linke Rad sich unterschiedlich schnell
drehen bei einer Kurvenfahrt und somit auch eine unterschiedliche Position
angeben würden. Durch eine anschließende Multiplikation mit dem Reifenradius $r$
erhält man die Position des zweiten Fahrzeugs in Metern.

Für die Position des ersten Fahrzeugs wird auf die Position des ersten Fahrzeugs
der gemessene Abstand des Ultraschallsensors addiert. Somit erhält man die
Position des zweiten Fahrzeugs in Abhängigkeit des Ultraschall Sensors.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.49\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/zustand_position.png}
\end{subfigure}
    \caption{Plot der Position des 1. und 2. Fahrzeugs in Abhängigkeit der Zeit.
    \label{fig:zustand_position}}
\end{figure}    
In Abbildung~\ref{fig:zustand_position} ist die jeweilige Position in
Abhängigkeit der Zeit dargestellt. Die rosa Kurve (Fahrzeug 2) zeigt einen
stetigen Anstieg, nachdem das Fahrzeug die Fahrt aufgenommen hat. Die grüne
Kurve (Fahrzeug 1) zeigt einen um $0.5 \mathrm{m}$ verschobenen Verlauf, der
über den initialen Abstand zustande kommt. Allerdings weist der Verlauf immer
wieder Sprünge auf. Diese kommen durch die Kurvenfahrten Zustande, bei denen der
Ultraschallsensor den Kontakt zum Fahrzeug verliert. Die generierte Position des
Fahrzeugs 1 ist somit nicht vollständig und muss in diesen Zeiträumen korrigiert
werden. Dies geschieht mit dem in Abschnitt~\ref{sec:kalmanfilter} beschriebenen
Kalmanfilter. Basis dafür ist allerdings eine Fallunterscheidung, die
automatisch erkennt, ob sich das Fahrzeug gerade in einer Kurve befindet oder
nicht. Diese wird im Abschnitt~\ref{sec:fallunterscheidung} beschrieben.

%-------------------------------------------------------------------------------
\section{Fallunterscheidung}\label{sec:fallunterscheidung}
Ziel des Fallunterscheidung Blocks (in Matlab genannt Kurvenfahrt Switch) ist es
ein Signal zu generieren, welches anzeigt ob sich eins der beiden Fahrzeuge
gerade in einer Kurvenfahrt befindet oder ob beide Fahrzeuge geradeaus fahren.
Von Fahrzeug 2 kann dafür der Lenkwinkel genutzt werden, von Fahrzeug 1
lediglich die Abstandsmessung durch denn Ultraschallsensor.
\begin{figure}[hbt]
\centering
\begin{subfigure}{1.0\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/abstand_switch_fulll.png}
\end{subfigure}
    \caption{Übersicht über den Switch zwischen Kurven-und Geradeausfahrt
    \label{fig:switch-full}}
\end{figure}
In Abbildung~\ref{fig:switch-full} ist eine Übersicht des ganzen Blocks
dargestellt. Zunächst haben wir uns Gedanken gemacht, welche Szenarien es für
die Kurvenfahrt gibt:
\begin{itemize}
    \item Fahrzeug 1 ist in der Kurve - Kann durch den Ultraschallsensor
        festgestellt werden
    \item Fahrzeug 2 ist in der Kurve - Kann durch den Lenkwinkel der
        Lenkregelung festgestellt werden
    \item Weder Fahrzeug 1 noch Fahrzeug 2 befinden sich in der Kurve -
        Geradeausfahrt
\end{itemize}
Diese Logik musste nun mit Simulink umgesetzt werden. Resultierend sollte ein
Signal sein, welches 1 ausgibt, wenn sich keines der beiden Fahrzeuge in der
Kurve befindet und 0 ausgibt, wenn sich mindestens eines der beiden Fahrzeuge in
der Kurve befindet (und somit keine zuverlässige Abstandsmessung mehr gegeben
ist). Wir gingen dabei so vor, dass wir versuchten ein Triggerpunkt für die
Kurveneinfahrt von Fahrzeug 1 zu finden, sowie das gleiche für Fahrzeug 2 bei
der Kurvenausfahrt. Die Punkte gemeinsam sollten dann jeweils das Signal von 1
auf 0 und umgekehrt schalten.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.9\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/mem_block.png}
\end{subfigure}\\
\begin{subfigure}{0.6\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/mem_sign.png}
\end{subfigure}
    \caption{Blockschaltbild (oben) und dazugehöriges Signal (unten) zum Signal
        umschalten
    \label{fig:umschalt}}

\end{figure}    
Dazu haben wir uns zunächst mit Hilfe eines Memory Blocks ein System überlegt,
mit dem man durch Triggerpunkte ein Signal jeweils umschalten kann. In
Abbildung~\ref{fig:umschalt} ist eine Übersicht gegeben. Das Signal
\textit{M-IN} ist konstant 0 und gibt durch einen Peak den Befehl zum
Umschalten. Daraufhin wird das Outputsignal \textit{M-OUT} konstant auf 1
geschaltet. Dies wird durch das Reset Signal \textit{M-RES} rückgängig gemacht,
welches von konstant 1 einen Peak auf 0 hat bei $T=5$. Durch dieses System
können wir uns einen Switch bauen, welcher auf die jeweiligen Kurven Ein-und
Austritten reagiert. Im nächsten Schritt haben wir uns dann Möglichkeiten
überlegt um diese Fälle als Signale erfassen zu können.

\begin{figure}[hbt]
\centering
\begin{subfigure}{0.4\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/abstand_ultraschall.png}
\end{subfigure}
\begin{subfigure}{0.4\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/abstand_lenkw.png}
\end{subfigure}

    \caption{Signale zur Erklärung des Switches zur Kurvenfahrt, Fahrzeug 1
        (links) und Fahrzeug 2 (rechs)
    \label{fig:umschaltsign}}
\end{figure}    

Zunächst schauen wir uns an, wann das Fahrzeug 1 in die Kurve eintritt (System 1
in Abbildung~\ref{fig:switch-full}). Die relevanten Signale sind in
Abbildung~\ref{fig:umschaltsign}~(links) dargestellt. Als Ausgangssignal dient
der Ultraschallsensor. Bei jedem Kurveneintritt von Fahrzeug 1 springt dieser
vom tatsächlichen Abstand auf $3\mathrm{m}$. Durch die Ableitung des Signals
bekommt man einen sehr großen Peak (theoretisch unendlich wegen dem Sprung),
welcher durch die Überprüfung $<1000$ auf ein boolsches Signal umgewandelt wird.
Anschließend wird das oben gezeigte Triggerpunkt Verfahren verwendet um das
Ausgangssignal \textit{SENSOR\_FZ2\_SWITCH} konstant auf 1 zu halten. Der Reset
am Kurvenausgang kommt durch die Funktion von Fahrzeug 2 zustande, da die Kurve
erst abgeschlossen ist, wenn Fahrzeug 2 (nach dem ersten Fahrzeug) die Kurve
verlassen hat. Dies sieht man daran, dass das Signal
\textit{SENSOR\_FZ2\_SWITCH} etwas länger als den Signalverlust des
Ultraschallsensors aktiviert bleibt.

Nun kommen wir zum Fahrzeug 2. Hier können wir die Bestimmung der Kurvenfahrt
über den Lenkwinkel lösen (System 2 in Abbildung~\ref{fig:switch-full}). Die
relevanten Signale sind in Abbildung~\ref{fig:umschaltsign}~(rechts)
dargestellt. Zunächst wird überprüft ob der Lenkwinkel $\leq 3$ oder $\geq 3$
ist, was unsere Bedingung zur Kurvenfahrt darstellt (Erfahrungswert).
Anschließend wird durch den bereits beschriebenen Triggerpunkt Switch das
resultierende Signal gebildet und Schlussendlich mit dem Signal der Kurvenfahrt
von Fahrzeug 1 zusammengeführt. Als Reset Bedingung für beide Signale gilt, dass
Fahrzeug 1 bereits die Kurvenfahrt abgeschlossen hat (Lenkwinkel im
entsprechenden Intervall) und das Signal selbst noch auf Kurvenfahrt stehen muss
(notwendig, dass das System nicht unnötig getriggert wird).

%-------------------------------------------------------------------------------
\section{Kalmanfilter}\label{sec:kalmanfilter}
Bei der Implementierung des Kalman Filters war das Ziel eine zuverlässige
Schätzung des Abstandes zu gewährleisten, wenn der Kurvenfahrt Switch aktiviert
ist (sprich keine Abstandsschätzung mit Hilfe des Ultraschall Sensors möglich
ist). Zur Implementierung wurde der Matlab Code Block verwendet, da so am
einfachsten die jeweiligen Matrix Operationen umgesetzt wurden konnten. Als
Input dienten die jeweiligen vorher festgelegten Matrizen die Input Signale
$y_1$ (Position Fahrzeug 1) und $y_c$ (Switch Signal). Eine Übersicht ist in
Abbildung~\ref{fig:kalmanuebersicht} abgebildet.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.49\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/kalman_uebersicht.png}
\end{subfigure}

    \caption{Übersicht über die Implementierung des Kalman Filters
    \label{fig:kalmanuebersicht}}
\end{figure}    
Die Bestimmung der Matrizen $A_T$, $C$, $Q_K$ und $R_K$ wurde analog zu den
Vorlesungsfolien gemacht. Folgender Code wurde zur Berechnung des Kalman Filters
verwendet:
\begin{lstlisting}[language=matlab]
function [X_Kp1_hat, P_Kp1] = kalmann_filer(y1, ...
    ... y_c, A_T, C, Q_K, R_K, X0_hat,P_K)

    %Anpassen der Unsicherheiten je nach Kurvenstatus 
    if y_c == 0 
        R_K = R_K * 1;
    elseif y_c == 1
        R_K = R_K * 100000;
    end

    %Schritt 1
    K_K = P_K * C' * inv(C * P_K * C' + R_K);
    P_Kp = (eye(2) - K_K * C) * P_K;
    X_Kp_hat = X0_hat + K_K * (y1 - C * X0_hat);
    
    %Schritt 2: Neue Werte berechnen
    X_Kp1_hat = A_T * X_Kp_hat;
    P_Kp1 = A_T * P_Kp * A_T' * Q_K;
end
\end{lstlisting}
Im wesentlichen ist die Implementierung analog zur Vorlesung. Wichtig ist, dass
die Unsicherheitsmatrix $R_k$ angepasst wird in Abhängigkeit ob sich die
Fahrzeuge in einer Kurvenfahrt befinden oder nicht. Initialisiert wird diese
Matrix als Einheitsmatrix. Befinden sich die Fahrzeuge in der Kurve so wird der
Wert 100000 hinzu multipliziert. Je größer die Werte auf der Diagonalen von
$R_k$, desto weniger werden die Messwerte herangezogen, sondern die Schätzung.
Dies bewirkt, dass für die Kurvenfahrt quasi alle Werte geschätzt werden,
während bei der Geradeausfahrt lediglich die Messwerte herangezogen werden.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.49\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/kalmanvgl.png}
\end{subfigure}
    \caption{Vergleich Abstand Ultraschallsensor zu Abstand mit Kalman Filter
    \label{fig:kalmanvgl}}
\end{figure}    
In Abbildung~\ref{fig:kalmanvgl} sind die rohen Abstandssignale des
Ultraschallsensors, sowie die errechnete Position des Kalman Filter dargestellt.
Man kann deutlich sehen, dass sobald, der Ultraschallsensor ausfällt, die
errechneten Werte des Kalman Filters die Abstandsmessung sinnvoll ergänzen.

Nach dem Kalman Filter durchlaufen die Ergebnisse einen Führungsgrößengenerator.
Hier wird nur der Sollabstand vom korrigierten Abstand des Kalman Filters
abgezogen um eine Sinnvolle Führungsgröße zu erhalten.

%-------------------------------------------------------------------------------
\section{Lueneberger Beobachter}\label{sec:Lueneberger Beobachter}
Der Lueneberger Beobachter dient zur Rekonstruktion der nicht messbaren Zustände
des Systems. Der Beobachter wurde anlog zum Buch \textit{Lunze - Regelungstechnik
2}\footnote{Lunze 2020 - Regelungstechnik 2 - Mehrgrößensystem, Digitale Regelung,
Seite 378} ausgelegt. Zunächst wurde dazu die Beobachtbarkeit und Steuerbarkeit
aus der Zustandsraumdarstellung überprüft. Anschließend wurde über den
\textit{place} Befehl in Matlab die Rückführungsmatrix erzeugt.
\begin{figure}[hbt]
\centering
\begin{subfigure}{0.6\textwidth}
    \centering
    \includegraphics*[width=\textwidth]{figures/lueneberger.png}
\end{subfigure}
    \caption{Übersicht über den Lueneberger Beobachter
    \label{fig:lueneberger}}
\end{figure}    
In Abbildung~\ref{fig:lueneberger} ist die Übersicht über die Implementierung
gegeben. Im wesentlichen wurden die Matrix Operationen lediglich in
Simulinkblöcke übersetzt. Schlussendlich wird noch ein Analog Digital Wandler
hinzugefügt um die Ergebnisse des Lueneberger Beobachters auch für die
Weiterverarbeitung (Zusammen mit dem Kalman Filter) verwenden zu können.

%-------------------------------------------------------------------------------
\section{Regelung}\label{sec:Regelung}
In diesem Teil geht es um die Regelung des Abstandes. Die Führungsgröße (sprich
der zu haltende Abstand) ist dabei variabel und kann im Matlab Skript durch eine
Variable zur Initialisierung eingestellt werden.

%-------------------------------------------------------------------------------
\subsection{PID-Regler}\label{subsec:PID-Regler}

%-------------------------------------------------------------------------------
\subsection{Optimale Regelung}\label{subsec:optimale_regelung}

%-------------------------------------------------------------------------------
\subsection{Polzuweisung}\label{subsec:polzuweisung}
